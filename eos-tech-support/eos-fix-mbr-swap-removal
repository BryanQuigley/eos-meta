#!/bin/bash -e
# Copyright (C) 2018 Endless Mobile, Inc.
# Licensed under the GPLv2.
#
# eos-fix-mbr-swap-removal: Fix a MBR partition table that was corrupted during
# swap reclaiming.
#
# Since we disabled the use of a swap partition on Endless systems, the
# eos-reclaim-swap service removes the unused swap partition, if existent, and
# extends the root partition and filesystem to make use of that space. But on
# some systems with an MBR partition table, eos-reclaim-swap ends up corrupting
# the partition table in a way that leaves the system unable to boot. This
# script can be used from a live environment to fix the partition table and
# make the system able to boot again.
#
# https://phabricator.endlessm.com/T24454
# https://phabricator.endlessm.com/T24493

if [[ ${#} -ne 1 ]] ; then
    echo "Usage: ${0} DEVICE"
    exit 1
fi

WORKDIR=$(mktemp --directory --tmpdir $(basename ${0})-XXXXXXXXXX)
chmod 755 ${WORKDIR}
PARTITIONS_FILE="${WORKDIR}/partitions.txt"
LOG_FILE="${WORKDIR}/$(basename ${0})-logs-$(date --iso-8601=seconds).txt"

print_log() {
    echo "${1}" >> ${LOG_FILE}
}

print_log_with_partitions() {
    print_log "${1}"
    cat ${PARTITIONS_FILE} >> ${LOG_FILE}
}

exit_error() {
    print_log_with_partitions "Error: ${1}"
    rm ${PARTITIONS_FILE}
    echo "Error: ${1}" > /dev/stderr
    echo "Logs saved to ${LOG_FILE}."
    exit ${2}
}

root_disk=${1}
sfdisk -d ${root_disk} > ${PARTITIONS_FILE}

# Check this is a MBR partiton table
label_type=$(sed -n -e 's/^label: [ ]*\(.*\)$/\1/p' ${PARTITIONS_FILE})
if [[ ${label_type} != "dos" ]] ; then
    exit_error "Error: This is not a MBR partition table." 2
fi

# Check that the partition starting at 144585 is a bootable Linux partition
type83_bootable=$(sed -n -e 's/^.*start=[ ]*144585,.*\(type=83, bootable\).*$/\1/p' ${PARTITIONS_FILE})
if [[ ${type83_bootable} != "type=83, bootable" ]] ; then
    exit_error "Error: The partition starting at 144585 is not a bootable Linux partition." 3
fi

# Change the starting of the bootable Linux partition from 144585 to 131072
print_log_with_partitions "Original partition table:"
sed -i -e 's/\(start=[ ]*\)144585\(.*\), size=[ ]*[^,]*/\1131072\2/' ${PARTITIONS_FILE}
print_log_with_partitions "New partition table:"
print_log "$(sfdisk --force --no-reread ${root_disk} < ${PARTITIONS_FILE} 2>&1)"
rm ${PARTITIONS_FILE}
udevadm settle
print_log "$(lsblk -f ${root_disk})"
echo "Partition table fixed, logs saved to ${LOG_FILE}."
