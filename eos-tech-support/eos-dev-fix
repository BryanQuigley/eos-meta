#!/bin/sh

mount -o remount,rw /usr

if [ $? -ne 0 ]; then
  echo "Failed to remount /usr readwrite - exiting"
  exit 1
fi

# 4th element in mountinfo is the "root" within a mounted filesystem, 5th is
# where it's mounted. Hence dig out where our root is coming from, so we're
# always using the _current_ root filesystem instead of the last updated
# version
OSTREE_DEPLOY_CURRENT=$(cat /proc/self/mountinfo | \
  egrep '([^ ]* ){4}/ ' | cut -d ' ' -f 4)

echo "Copying files from $OSTREE_DEPLOY_CURRENT"

if [ ! -d /var/lib/dpkg ]; then
  cp -a $OSTREE_DEPLOY_CURRENT/var/lib/dpkg /var/lib/
  cp -a $OSTREE_DEPLOY_CURRENT/var/lib/xml-core /var/lib/
  cp -a $OSTREE_DEPLOY_CURRENT/var/lib/sgml-base /var/lib/
  cp -a $OSTREE_DEPLOY_CURRENT/var/cache/debconf /var/cache/
  apt-get update
else
  echo "dpkg database already found - exiting"
fi

if [ ! -d /var/lib/locales ]; then
  cp -a $OSTREE_DEPLOY/current/var/lib/locales /var/lib/
fi
